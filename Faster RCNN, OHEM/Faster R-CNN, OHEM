# Faster R-CNN, OHEM

Created At: 2021ë…„ 8ì›” 6ì¼ ì˜¤ì „ 12:31
Created By: ì¡°ìŠ¹ì œ
Topics: Deep Learning, Object Detection
Type: ğŸ“’ Lesson
ë°œí‘œì¼: 2021ë…„ 8ì›” 6ì¼
ë°œí‘œì: ì¡°ìŠ¹ì œ
ì°¸ì„ì: ì¡°ê±´ìš°, ì—„í˜„ì‹

# Faster R-CNN (2015)

## 1. Introduction

- Fast R-CNNì˜ ë‹¨ì ì„ ë³´ì™„
    - Fast R-CNNì˜ Test time 2.3ì´ˆ ì¤‘ 2ì´ˆê°€ Region Proposalì— ì†Œìš”ë¨
    - Fast R-CNN ë˜í•œ ì™„ë²½í•œ ì˜ë¯¸ì˜ end-to-end networkëŠ” ì•„ë‹˜ (SS)
- ì´ë¥¼ CNN ë‚´ë¶€ì—ì„œ ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ Region Proposal Network(RPN)ì„ ë„ì…
- RPNì€ region proposalsë¥¼ ë³´ë‹¤ ì •êµí•˜ê²Œ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ Anchor boxë¥¼ ë„ì…

![Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled.png](Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled.png)

![Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2021-07-29_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_10.39.02.png](Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2021-07-29_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_10.39.02.png)

## 2. Anchor Box

![Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2021-07-29_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_10.54.16.png](Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2021-07-29_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_10.54.16.png)

![Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%201.png](Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%201.png)

- scale(w, h), aspect ratio(w, hì˜ ë¹„ìœ¨)ì„ ì¡°ì •í•˜ì—¬ ë‹¤ì–‘í•œ í¬ê¸°ì˜ anchor box ì •ì˜ ê°€ëŠ¥
- ë‹¤ì–‘í•˜ê²Œ ì •ì˜í•˜ë©´ ì¢€ ë” ì •í™•í•œ localization ì„±ëŠ¥ì„ ì–»ì„ ìˆ˜ ìˆê³  ë‹¤ì–‘í•œ í¬ê¸°ì˜ ê°ì²´ë¥¼ í¬ì°©í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥
- selective search ë°©ì‹ë³´ë‹¤ ì‹œê°„ë„ ë‹¨ì¶•, mAP ë˜í•œ ìƒìŠ¹
- anchor boxëŠ” ì›ë³¸ ì´ë¯¸ì§€ì˜ ê° grid cellì„ ì¤‘ì‹¬ìœ¼ë¡œ ìƒì„±í•˜ëŠ”ë°, ì›ë³¸ ì´ë¯¸ì§€ì—ì„œ sub-sampling ratioë¥¼ ê¸°ì¤€ìœ¼ë¡œ anchor boxê°€ ìƒì„±ë¨

## 3. RPN (Region Proposal Network)

- CNNìœ¼ë¡œë¶€í„° feature mapì„ ì…ë ¥ë°›ì•„ anchorì— ëŒ€í•œ class score, bounding box regressorë¥¼ ë°˜í™˜í•˜ëŠ” ì—­í• 

![Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/img.png](Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/img.png)

1. ì›ë³¸ ì´ë¯¸ì§€ë¥¼ CNNì„ í†µí•´ feature mapì„ ì–»ìŒ
2. feature mapì— 3x3 conv ì—°ì‚° ìˆ˜í–‰ (same padding)
3. class score ê³„ì‚°ì„ ìœ„í•´ 1x1 conv ì—°ì‚° ìˆ˜í–‰ (RPNì—ì„œëŠ” í›„ë³´ ì˜ì—­ì— ê°ì²´ê°€ í¬í•¨ë˜ì–´ìˆëŠ”ì§€ë§Œì„ ë¶„ë¥˜)
4. bounding box regressorë¥¼ ìœ„í•´ 1x1 conv ì—°ì‚° ìˆ˜í–‰
5. ì´í›„ class scoreì— ë”°ë¼ ìƒìœ„ Nê°œì˜ region proposalsë§Œì„ ì¶”ì¶œí•œ í›„ NMSë¥¼ ì ìš©í•˜ì—¬ Fast R-CNNì— ì „ë‹¬

## 4. Loss Function

- For training RPNs, we assign a binary class label (of being an object or not) to each anch
- positive label ì¶”ì¶œ
    - the anchor/anchors with the highest Intersection-overUnion (IoU) overlap with a ground-truth box (ê°€ë” ì í•©í•˜ì§€ ì•Šì€ ë°ì´í„°ê°€ labelë˜ëŠ” ê²½ìš°ê°€ ìˆì–´ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
    - an anchor that has an IoU overlap higher than 0.7 with any ground-truth box

![Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%202.png](Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%202.png)

$i$ = the index of an anchor in a mini-batch

$p_i$ = the predicted probability of anchor i being an object

$p_i^*$ = anchorê°€ positiveì¼ ê²½ìš° 1, negativeì¼ ê²½ìš° 0

$t_i$ = vector representing the 4 parameterized coordinates of the predicted bounding box

$t_i^*$ = ground-truth box associated with a positive anchor

$L_{cls}$ = log loss over two classes (object vs. not object)

$L_{reg}$ = Smooth L1 loss (bounding box regression)

$N_{cls}$ = mini-batch size

$N_{reg}$ = the number of anchor locations

Î» = balancing parameter

## 5. Training

- RPNê³¼ Fast R-CNNì„ ë”°ë¡œ í›ˆë ¨ì‹œí‚´

1. RPNì„ í›ˆë ¨ (pre-trained modelë„ í›ˆë ¨ë¨)
    1. This network is initialized with an ImageNet-pre-trained model and fine-tuned end-to-end for the region proposal task.
2. Fast R-CNN í›ˆë ¨ (pre-trained modelë„ í›ˆë ¨ë¨)
    1. we train a separate detection network by Fast R-CNN using the proposals
    generated by the step-1 RPN
    2. At this point the two networks do not share convolutional layers
3. RPNì„ í›ˆë ¨ (pre-trained model fix)
4. Fast R-CNN í›ˆë ¨ (pre-trained model fix)

ì´ ë°©ë²•ì´ ë³µì¡í•´ì„œ ì´í›„ì—  Alternating training(ë…¼ë¬¸ì—ì„œ ì‚¬ìš©) â†’ Approximate Joint Training â†’ Non-approximate joint training ìœ¼ë¡œ í›ˆë ¨ ë°©ë²•ì„ ë°”ê¿ˆ

## 6. EXPERIMENTS

![Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2021-08-04_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_6.30.45.png](Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2021-08-04_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_6.30.45.png)

![Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%203.png](Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%203.png)

![Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%204.png](Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%204.png)

---

# OHEM (2016)

## 1. Introduction

- In this paper, we propose a novel bootstrapping technique called online hard example mining (OHEM) for training state-of-the-art detection models based on deep ConvNets
- hard negative miningì€ ë¹„íš¨ìœ¨ì ì´ë‹¤

## 2. Hard Negative Mining

- ëª¨ë¸ì´ ì˜ëª» ì˜ˆì¸¡í•œ, ì–´ë ¤ìš´(hard) sampleì„ ì¶”ì¶œí•˜ëŠ” ë°©ë²•
- object detection ëª¨ë¸ì´ ìˆë‹¤ê³  í•  ë•Œ, positive sampleì€ ê°ì²´ì— í•´ë‹¹í•˜ëŠ” ì˜ì—­ì´ë©°, negative sampleì€ ë°°ê²½
- ì—¬ê¸°ì„œÂ ëª¨ë¸ì´ ì˜ˆì¸¡í•˜ê¸° ì–´ë ¤ìš´ sampleì€ ì£¼ë¡œ False Positive sample
- ê¸°ì¡´ì—ëŠ” Hard Negative Miningì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë¸ì´ ì˜ˆì¸¡í•˜ê¸° ì–´ë ¤ìš´ sampleì„ ì¶”ì¶œí•œ í›„, í•™ìŠµ ë°ì´í„°ì— í¬í•¨ì‹œì¼œ ëª¨ë¸ì´ False Positive ì˜¤ë¥˜ì— ê°•ê±´í•´ì§€ë„ë¡ í•™ìŠµ

- ë…¼ë¬¸ ì €ìëŠ” Hard Negative Miningì€ **íœ´ë¦¬ìŠ¤í‹±(Heuristic)**í•˜ë‹¤ê³  ì–¸ê¸‰.
- ì§€ì •í•´ì•¼ í•˜ëŠ” í•˜ì´í¼ íŒŒë¼ë¯¸í„°(positive/negative sampling ratio, IoU threshold ë“±)ê°€ ë§ì•„ ì‹¤í—˜ìì˜ ê°œì…ê³¼ ì‹œí–‰ì°©ì˜¤ê°€ ë§ì´ í•„ìš”

â†’ False Positive sampleë¥¼ mini-batchë¡œ ì£¼ëŠ” ëŒ€ì‹  lossê°€ í° ë°ì´í„°ë“¤ë¡œ í›ˆë ¨ì„ ì‹œí‚¤ì

- lossê°€ í° ë°ì´í„°ì— gradiantê°€ í¬ê²Œ ì£¼ì–´ì§€ë‹ˆê¹Œ

## 3. OHEM(Online Hard Example Mining)

![Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%205.png](Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%205.png)

![Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%206.png](Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%206.png)

![Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%207.png](Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%207.png)

## 4. OHEM Training

1. Fast R-CNNê³¼ ê°™ì€ Forward ìˆ˜í–‰
    1. Image â†’ CNN â†’ feature map
    2. Selective search â†’ RoIs
2. aì™€ b ê³¼ì •ì˜ outputìœ¼ë¡œ RoI poolingìˆ˜í–‰
3. FC Layer, Classifier, Bounding Box Regressor ê±°ì³ ê° RoIë³„ë¡œ loss ê³„ì‚°
4. RoIë¥¼ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬ í›„ NMS(threshold = 0.7)ë¥¼ ì ìš©í•´ì„œ lossê°’ì´ í° RoIë§Œ back propagation

## 5. ì¥ì 

- Fast R-CNNì€ mini-batchë¥¼ ë§Œë“¤ ë•Œ RoIì™€ Ground Truthì˜ IoUê°€ 0.5 ì´ìƒì´ë©´ positive, ì´í•˜ì´ë©´ negativeë¡œ sampling

    â†’ Sampling ê³¼ì •ì´ ì—†ì–´ì§€ë©´ì„œ í›ˆë ¨ ì‹œê°„ì´ 2ë°° ì´ìƒ ë‹¨ì¶•ë¨

- Sampling ê³¼ì •ì—ì„œ ì‚¬ìš©ëœ thresholdë“±ì˜ hyper parameterë¥¼ ì œê±°í•  ìˆ˜ ìˆê²Œ ë¨

    â†’ Heuristic ë°©ì‹ X

- ì¸ìœ„ì ì¸ ê°œì…ì´ í•„ìš”í–ˆë˜ ë¶€ë¶„ë“¤ì„ ì œê±°í•˜ë©´ì„œ í›ˆë ¨ ì†ë„ë‚˜ ë©”ëª¨ë¦¬ ë©´ì—ì„œë„ ë¹ ë¥´ê³  ì•ˆì •ì ìœ¼ë¡œ í›ˆë ¨ì´ ê°€ëŠ¥í•´ì§

## 6. EXPERIMENTS

![Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%208.png](Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%208.png)

![Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%209.png](Faster%20R-CNN,%20OHEM%20be37a87a44b040b18fb691234935a224/Untitled%209.png)